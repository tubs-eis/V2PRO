
# CNN Converter

21.11.2022: **ReWork**  
07.02.2023: **Rework -> Main Merge**  
xx:**Verification Scripting (NN_Quant Repository) + FPGA execution**

## Folders

- `/netgen/`:
     Host Processing: CNN base layer and infrastructure library
     - Input data segmentation for workload distribution across clusters/units/lanes
     - Hardware Mapping, e.g. logic mapping to adjactent vector units / lanes
     - Command generation, e.g. double buffering sensitive dma and vpro command extraction for defined structure
- `/nets/`:
	 All net-specific stuff lives here, one subdir per CNN, e.g yololite. Makefile targets (make gen_yololite, sim_yololite, ...) automatically available for each subdir of `/nets/`
	 - yololite (default demo)
		Common dir structure for all nets:
		- `src/`: CNN graph (*.[cpp|h])
		- `weights/`: Quantized CNN weights, generated by quantization framework
		- `generated/`: Binary CNN descriptor (BIF format), generated by netgen (e.g. make gen_yololite)
		- `input/`: CNN input data, used by ISS
		- `init/`: ISS init scripts
		- `exit/`: ISS exit scripts
		- `sim_results/`: CNN output data, generated by ISS
	 - efficientnet
	 - ...
- `/bif/`:
     Binary Interface Format of executable CNN description; data generated by netgen, consumed by runtime
- `/runtime/`:
     Library functions required during execution by the VPRO, including print functions, etc. Consumes executable CNN description (BIF format)
- `/sim/`:  
     Wrapper for ISS simulation of `/runtime/`
- `/legacy/`:
     Previous CNN Converter, debug-dumps added


## netgen Class Hierarchy

Frontend: collect all required information
- Parameter container
- Store CNN graph as source and destination layers
- Load weights and quantization parameters

Backend: generate binary (BIF) representation
- Input segmentation
- V2PRO + DMA command generation
- Scheduling


### Layers
Purpose:
- Describe Configuration of a single Layer (Processing Step)
- Used for Segmentation to Lanes, Memory Layout and Command List generation

###### Available Layers & Activations
Base class: `Layer`
Derived classes: `Conv2D`, `YoloConv2D`, ...

| Conv Layer		| Implementation 	| Issue 	| Comment   										| Reference 																				|
|---	    		|:-:				|:-:		|---	    										|---	    																			|
| Conv2D  			| yes  				|   		|                                                   |   	   																		 		|
| YoloConv2D  		| yes  				|   		| Conv2D + LeakyRelu + MaxPooling (2x2)				|   	   																		 		|
| Depthwise Conv  	| yes  				| [5](https://git.rz.tu-bs.de/theoretische-informatik/ti/zuse-ki-avf/app/cnn_yololite_hw/-/issues/5)  		| use Conv2D.groups = filters				|   	   																		 		|
| Conv2DTranspose   | yes               | [6](https://git.rz.tu-bs.de/theoretische-informatik/ti/zuse-ki-avf/app/cnn_yololite_hw/-/issues/6)        | Implementation for stride 1 and 2         | [Keras](https://keras.io/api/layers/convolution_layers/convolution2d_transpose/) |
| Deformable Conv  	| in progress		| [1](https://git.rz.tu-bs.de/theoretische-informatik/ti/zuse-ki-avf/app/cnn_yololite_hw/-/issues/1)  		| #inchannel must be multiple of 8 (?)				| [Link](https://paperswithcode.com/method/deformable-convolution)						|
| FullyConnected  	| in progress		| [3](https://git.rz.tu-bs.de/theoretische-informatik/ti/zuse-ki-avf/app/cnn_yololite_hw/-/issues/3)  		| 													|   	    																			|
| Conv1D 			| no				|   		| possible via conv2d currently						|   	  																		  		|

| Layer	 			| Implementation 	| Issue 	| Comment   										| Reference 																				|
|---	    		|:-:				|:-:		|---	    										|---	    																			|
| MaxPooling  		| yes  				|   		| Maximum of 2x2 window								|   	   																		 		|
| Addition  		| yes		        | [2](https://git.rz.tu-bs.de/theoretische-informatik/ti/zuse-ki-avf/app/cnn_yololite_hw/-/issues/2)  		| Same Resolution, no dimension increase 			|   	   																		 		|
| AvgPool 			| no				|   		| by accumulation + multiplication with e.g. 1/9 	|   	  																		  		|
| AdaptiveAvgPool 	| no				|   		| 													| [Link](https://stackoverflow.com/questions/53841509/how-does-adaptive-pooling-in-pytorch-work)|
| Concat 			| no				|   		| 													|   	  																		  		|

| Activations	| Implementation 	| Issue 	| Comment   								| Reference  									|
|---	    	|:-:				|:-:		|---	    								|---	    									|
| LeakyRelu  	| yes  				| 	  		| negative: x 0.1, positive: x 1 (linear)  	|   	   										|
| Relu6   		| yes 			 	| 	  		| (linear) Maximal Value: 6 (cutoff) 	 	|   	   										|
| RectRelu  	| yes 			 	| 	  		| Minimal Value: 0, Maximal Value: 1 	 	|   	    									|
| Sigmoid  		| yes	            | 	  		|   								 	 	|   										    |
| Silu  		| no 			 	| ([4](https://git.rz.tu-bs.de/theoretische-informatik/ti/zuse-ki-avf/app/cnn_yololite_hw/-/issues/4))  		| input x sigmoid(input)			 	 	| [Link](https://paperswithcode.com/method/silu)  	    |


### Nets
Purpose:
- CNN graph: instantiate and connect layers
- Aggregate layers into CNN
- VPRO memory layout
    - Input, results, commands, weights
- Build binary CNN descriptor from layer commands
- File export
    - Binary CNN descriptor (BIF format)
    - Simulation helpers

###### Available Nets
Base class: `Net`
Derived classes: `Yololite`, `Efficientnet`, ...
Derive separate class to instantiate a new net, overload `instantiateLayers()`


## CNN Tool Flow

exemplary new CNN: __e-cnn__

1. Quantize Parameters of CNN for VPRO execution
    1. Store weights binary in folder: `/nets/e-cnn/weights/layer_<nr>_weights.bin`
    1. **WIP**: Store shift parameters in .inc file
1. Definition of CNN structure in `/nets/e-cnn/src/e-cnn_net.h`
1. Call of netgen: `make gen_e-cnn`
    1. generation of binary configuration blob (binary large file object) in `/nets/e-cnn/generated/`:
        - `eisvblob.bin`: contains layer information, vpro + dma command lists
        - `vproblob.bin`: contains weights for execution
        - `.txt` contains debug information (ascii representation of commands, ...)
    1. binary interface definition (**bif**) is defined in /bif/bif.h
        - enums (mostly global)
1. Simulation will execute generated CNN structure (bin definition)
    1. main in `/sim/sim.cpp`
    1. MM init script + data from `/nets/e-cnn/init` & `data` (as exit + dump)
        1. contains blob files
    1. custom simulation exectable used for dumps + debug functions
1. Binary compilation for FPGA (Risc-V Compiler): **WIP**
    1. main in `/runtime/runtime.cpp`
    1. includes Host communication (consecutive inference)


## Emulation
`make emu_<cnn>`  
Results in `nets/<cnn>/emu_results`

### Setup Linux on Aldec TySOM-3A
- Write image https://github.com/aldec/TySOM-PYNQ/releases/download/2.7/tysom3a_v2.7.0.img.7z to microSD card (> 8 GB)
    - Windows: e.g. BalenaEtcher
- Insert card into PS (boot) card socket CON8 (below DisplayPort connector)
- Initial system configuration via kernel UART console (if IP not known/ethernet unavailable)
    - Connect mini-USB cable to PS USB to UART connector (J7, top, next to DisplayPort connector)
    - 115200 bps
    - Host:
        - Linux: e.g. minicom
        - Windows: e.g. PuTTY
    - u-boot, kernel messages and login prompt should appear after power-up
- Security / convenience:
    - default user `xilinx`, password `xilinx`
    - change password or
    - disable ssh password login in `/etc/ssh/sshd_config`
        - `PasswordAuthentication no`
    - enable public key authentication
        - `mkdir .ssh`
        - `nano .ssh/authorized_keys`
        - < paste public ssh key >
        - `chmod -R go-rwx .ssh`
- Prepare eth1 (CON6, next to power connector; may want to assign a useful MAC _before_ attaching the ethernet cable)
    - assign MAC in `/etc/network/interfaces.d/eth1`
        - `pre-up ifconfig ${IFACE} hw ether 00:0a:35:3a:xx:xx`
- Connect ethernet
- Host: configure ssh alias `aldec` for board in `~/.ssh/config` (used by emu_* Makefile target):
    - `Host aldec`
    - `    HostName < IP >`
    - `    User xilinx`
    - `    ForwardX11 yes # optional`
    - `    ForwardAgent yes # optional`
- `sudo visudo /etc/sudoers` # append lines:
    - `# grant group write access to files created by sudo (allow regular user to modify sudo-generated files)`
    - `Defaults umask=0002`
    - `# allow CNN execution as root without password`
    - `xilinx ALL=(ALL) NOPASSWD:SETENV: /home/xilinx/python_scripts/cnn/cnn_generic.py`
- Download from LUH Seafile
    - `ims-zuse-ki-avf/12_ap2/230329_pynq_folders_fast_bitstream_included.zip` (or later version)
    - unzip to `xilinx@pynq:~/`
    - `Makefile`: make sure `BITSTREAM` is set to the bitstream file contained in `.zip` (see `xilinx@pynq:~/overlays/`)
- Connect RISC-V UART console (local USB hardware loopback on TySOM-3A)
    - Mini-USB cable from PL UART (J11, bottom, below slide switch) to USB-A port
    - Results in `nets/<cnn>/emu_results/*.log`
    - Manual connection: `sudo miniterm /dev/ttyUSB0 115200 --filter=direct`


### Setup RISC-V gcc
- `git clone --recursive https://github.com/riscv/riscv-gnu-toolchain`
- `cd riscv-gnu-toolchain`
- `mkdir build; cd build`
- `../configure --prefix=/opt/<install dir> --with-arch=rv32im --with-abi=ilp32`
- `make -j`
- `make install`
- `export RISCV=<install dir>/riscv-gnu-toolchain/bin`
- `export RV_VPRO_EXT=0 # disable EISV extensions (or use EIS' gcc repo)`
- `make emu_<cnn>`


## Current Tasks
- Take a look @[Issue-List](https://git.rz.tu-bs.de/theoretische-informatik/ti/zuse-ki-avf/app/cnn_yololite_hw/-/issues)
- Script finalization (clean targets, folder generation, ...)
- Quantization Framework Project Integration (Submodule)
- Verification Tests (Unit) (e.g. with Quantization Script generated Reference)

###### Todo migrate from legacy to rework
- residual layer (Verification)

